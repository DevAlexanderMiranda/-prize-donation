<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Dados - Prize Donation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(45deg, #6c63ff, #5a54d1);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: clamp(320px, 90%, 1200px);
            margin: 20px auto;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            padding: clamp(15px, 3vw, 30px);
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #333;
            font-size: clamp(22px, 4vw, 28px);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #6c63ff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .logout-btn, .back-btn {
            background: none;
            border: none;
            color: #6c63ff;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: clamp(8px, 1.5vw, 10px) clamp(15px, 2.5vw, 20px);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            font-size: clamp(13px, 1.8vw, 14px);
        }
        
        .tab.active {
            border-bottom-color: #6c63ff;
            color: #6c63ff;
        }
        
        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: clamp(12px, 1.8vw, 13px);
        }
        
        th, td {
            padding: clamp(6px, 1.2vw, 8px) clamp(8px, 1.5vw, 10px);
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #444;
            font-size: clamp(11px, 1.6vw, 12px);
        }
        
        tr:hover {
            background-color: #f6f6f6;
        }
        
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            gap: clamp(5px, 1vw, 8px);
        }
        
        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: clamp(13px, 1.8vw, 14px);
            padding: clamp(3px, 0.8vw, 4px);
            border-radius: 4px;
        }
        
        .edit-btn {
            color: #2196F3;
        }
        
        .delete-btn {
            color: #FF5252;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 18px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            font-size: 14px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-header h3 {
            font-size: 18px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 13px;
        }
        
        input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input:focus {
            border-color: #6c63ff;
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
            outline: none;
        }
        
        .modal-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .cancel-btn {
            background-color: #f1f1f1;
            color: #555;
        }
        
        .save-btn {
            background-color: #6c63ff;
            color: white;
        }
        
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-container input {
            flex: 1;
            padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2vw, 15px);
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: clamp(14px, 2vw, 16px);
        }
        
        .search-container button {
            min-width: 45px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: clamp(13px, 1.8vw, 14px);
        }
        
        .search-btn {
            background: #6c63ff;
            color: white;
            padding: 0 20px;
        }
        
        .clear-btn {
            background: #f1f1f1;
            color: #555;
            padding: 0 20px;
        }
        
        .search-btn:hover {
            background: #5a54d1;
        }
        
        .clear-btn:hover {
            background: #e0e0e0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 5px;
            }
            
            .tabs {
                flex-direction: column;
                gap: 5px;
                border-bottom: none;
            }
            
            .tab {
                border-bottom: none;
                border-left: 3px solid transparent;
                background-color: #f9f9f9;
                margin-bottom: 5px;
                border-radius: 4px;
            }
            
            .tab.active {
                border-bottom-color: transparent;
                border-left-color: #6c63ff;
                background-color: #f0f0ff;
            }
            
            .search-container {
                flex-wrap: wrap;
            }
            
            .search-btn, .clear-btn {
                flex: 1;
                min-width: 80px;
            }
        }
        
        .user-dropdown {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .dropdown-toggle {
            background: none;
            border: none;
            color: #6c63ff;
            cursor: pointer;
            padding: 0 5px;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            width: 200px;
            z-index: 1000;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            color: #444;
            text-decoration: none;
            transition: background-color 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }
        
        .dropdown-item:hover {
            background-color: #f5f5f5;
        }
        
        .dropdown-divider {
            height: 1px;
            background-color: #eee;
            margin: 5px 0;
        }
        
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: #f5f5f5;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
            padding-right: 40px;
        }

        select:focus {
            border-color: #6c63ff;
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
            outline: none;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            text-transform: capitalize;
        }

        .category-diamante {
            background-color: #1abc9c;
        }

        .category-ouro {
            background-color: #f1c40f;
        }

        .category-prata {
            background-color: #95a5a6;
        }

        .category-bronze {
            background-color: #e67e22;
        }

        .category-brinde {
            background-color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Prize Donation</h1>
            <div class="user-info">
                <div class="avatar">U</div>
                <div class="user-dropdown">
                    <span id="user-name">Usuário</span>
                    <div class="dropdown">
                        <button class="dropdown-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item" data-page="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                            <a href="#" class="dropdown-item" data-page="cadastro-premio.html">
                                <i class="fas fa-trophy"></i> Cadastrar Prêmio
                            </a>
                            <a href="#" class="dropdown-item" data-page="gerenciar-dados.html">
                                <i class="fas fa-cog"></i> Gerenciar Dados
                            </a>
                            <a href="#" class="dropdown-item" data-page="gerenciar-usuarios.html">
                                <i class="fas fa-users"></i> Gerenciar Usuários
                            </a>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item logout-btn" id="logout-btn">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="doacoes">Doações</div>
            <div class="tab" data-tab="premios">Prêmios</div>
            <div class="tab" data-tab="secretarias">Secretarias/Empresas</div>
        </div>
        
        <div id="doacoes-tab" class="tab-content active">
            <h2>Gerenciar Doações</h2>
            <div class="search-container">
                <input type="text" id="pesquisa-doacao" placeholder="Pesquisar por colaborador, prêmio ou secretaria...">
                <button id="btn-pesquisar-doacao" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <button id="btn-limpar-pesquisa" class="clear-btn">
                    Limpar
                </button>
            </div>
            <div id="doacoes-list">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Prêmio</th>
                                <th>Qtd</th>
                                <th>Secretaria/Empresa</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="doacoes-table-body">
                            <!-- Dados serão carregados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="premios-tab" class="tab-content">
            <h2>Gerenciar Prêmios</h2>
            <div id="premios-list">
                <div class="table-responsive">
                    <table class="data-table" id="premios-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="premios-table-body">
                            <!-- Dados serão carregados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="secretarias-tab" class="tab-content">
            <h2>Gerenciar Secretarias/Empresas</h2>
            <div id="secretarias-list">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="secretarias-table-body">
                            <!-- Dados serão carregados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para editar prêmio -->
    <div class="modal" id="edit-premio-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Prêmio</h3>
                <button class="close-modal" id="close-edit-premio-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit-premio-nome">Nome do Prêmio</label>
                <input type="text" id="edit-premio-nome" placeholder="Digite o nome do prêmio">
            </div>
            <div class="form-group">
                <label for="edit-premio-categoria">Categoria</label>
                <select id="edit-premio-categoria" required>
                    <option value="diamante">Diamante</option>
                    <option value="ouro">Ouro</option>
                    <option value="prata">Prata</option>
                    <option value="bronze">Bronze</option>
                    <option value="brinde">Brinde</option>
                </select>
            </div>
            <input type="hidden" id="edit-premio-id">
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancel-edit-premio-btn">Cancelar</button>
                <button class="modal-btn save-btn" id="save-premio-btn">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para editar secretaria -->
    <div class="modal" id="edit-secretaria-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Secretaria/Empresa</h3>
                <button class="close-modal" id="close-edit-secretaria-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit-secretaria-nome">Nome da Secretaria/Empresa</label>
                <input type="text" id="edit-secretaria-nome" placeholder="Digite o nome da secretaria ou empresa">
                <input type="hidden" id="edit-secretaria-id">
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancel-edit-secretaria-btn">Cancelar</button>
                <button class="modal-btn save-btn" id="save-secretaria-btn">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmação de exclusão -->
    <div class="modal" id="delete-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Exclusão</h3>
                <button class="close-modal" id="close-delete-modal">&times;</button>
            </div>
            <p id="delete-message">Tem certeza que deseja excluir este item?</p>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancel-delete-btn">Cancelar</button>
                <button class="modal-btn save-btn" id="confirm-delete-btn" style="background-color: #FF5252;">Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para editar doação -->
    <div class="modal" id="edit-doacao-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Doação</h3>
                <button class="close-modal" id="close-edit-doacao-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit-doacao-colaborador">Colaborador</label>
                <input type="text" id="edit-doacao-colaborador" placeholder="Nome do colaborador">
            </div>
            <div class="form-group">
                <label for="edit-doacao-premio">Prêmio</label>
                <select id="edit-doacao-premio">
                    <!-- Opções serão carregadas dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="edit-doacao-quantidade">Quantidade</label>
                <input type="number" id="edit-doacao-quantidade" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="edit-doacao-secretaria">Secretaria/Empresa</label>
                <select id="edit-doacao-secretaria">
                    <!-- Opções serão carregadas dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="edit-doacao-data">Data</label>
                <input type="date" id="edit-doacao-data">
            </div>
            <div class="form-group">
                <label for="edit-doacao-nota-fiscal">Nº Nota Fiscal</label>
                <input type="text" id="edit-doacao-nota-fiscal" placeholder="Número da nota fiscal">
            </div>
            <input type="hidden" id="edit-doacao-id">
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancel-edit-doacao-btn">Cancelar</button>
                <button class="modal-btn save-btn" id="save-doacao-btn">Salvar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importar funções do Firebase
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            getDoc, 
            updateDoc, 
            deleteDoc,
            query,
            orderBy,
            Timestamp,
            where
        } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyClEmEGIZPH3MNMHzCi7F0E0AdwdLfukfY",
            authDomain: "prize-donate.firebaseapp.com",
            projectId: "prize-donate",
            storageBucket: "prize-donate.firebasestorage.app",
            messagingSenderId: "708034852355",
            appId: "1:708034852355:web:8f9e0c30aceb181e2dc036",
            measurementId: "G-V9ZWN6Q3FQ",
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Elementos DOM
        const premiosTableBody = document.getElementById('premios-table-body');
        const secretariasTableBody = document.getElementById('secretarias-table-body');
        const doacoesTableBody = document.getElementById('doacoes-table-body');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Modais
        const editPremioModal = document.getElementById('edit-premio-modal');
        const editSecretariaModal = document.getElementById('edit-secretaria-modal');
        const editDoacaoModal = document.getElementById('edit-doacao-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        
        // Inputs de edição
        const editPremioNome = document.getElementById('edit-premio-nome');
        const editPremioId = document.getElementById('edit-premio-id');
        const editSecretariaNome = document.getElementById('edit-secretaria-nome');
        const editSecretariaId = document.getElementById('edit-secretaria-id');
        
        // Inputs de edição de doação
        const editDoacaoColaborador = document.getElementById('edit-doacao-colaborador');
        const editDoacaoPremio = document.getElementById('edit-doacao-premio');
        const editDoacaoQuantidade = document.getElementById('edit-doacao-quantidade');
        const editDoacaoSecretaria = document.getElementById('edit-doacao-secretaria');
        const editDoacaoData = document.getElementById('edit-doacao-data');
        const editDoacaoNotaFiscal = document.getElementById('edit-doacao-nota-fiscal');
        const editDoacaoId = document.getElementById('edit-doacao-id');
        
        // Variável global para armazenar o item a ser excluído
        let deleteItemData = null;
        
        // Carregar prêmios
        async function carregarPremios() {
            try {
                const premiosQuery = query(collection(db, "premios"), orderBy("nome"));
                const querySnapshot = await getDocs(premiosQuery);
                
                premiosTableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    premiosTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Nenhum prêmio cadastrado</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const premio = doc.data();
                    const row = document.createElement('tr');
                    
                    // Formatação da data
                    let dataFormatada = 'Data não disponível';
                    if (premio.dataCriacao) {
                        if (premio.dataCriacao instanceof Timestamp) {
                            const data = premio.dataCriacao.toDate();
                            dataFormatada = data.toLocaleDateString('pt-BR');
                        } else if (premio.dataCriacao.toDate) {
                            const data = premio.dataCriacao.toDate();
                            dataFormatada = data.toLocaleDateString('pt-BR');
                        }
                    }
                    
                    // Capitalizar categoria
                    const categoria = premio.categoria ? premio.categoria.charAt(0).toUpperCase() + premio.categoria.slice(1) : 'Não especificada';
                    
                    row.innerHTML = `
                        <td>${premio.nome}</td>
                        <td><span class="category-badge category-${premio.categoria || 'brinde'}">${categoria}</span></td>
                        <td>${dataFormatada}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-id="${doc.id}" data-nome="${premio.nome}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" data-id="${doc.id}" data-nome="${premio.nome}" data-type="premio" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    premiosTableBody.appendChild(row);
                });
                
                // Adicionar event listeners para os botões de editar e excluir
                addEditPremioListeners();
                addDeleteItemListeners();
                
            } catch (error) {
                console.error("Erro ao carregar prêmios:", error);
                premiosTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Erro ao carregar prêmios</td></tr>';
            }
        }
        
        // Carregar secretarias
        async function carregarSecretarias() {
            try {
                const secretariasQuery = query(collection(db, "secretarias"), orderBy("nome"));
                const querySnapshot = await getDocs(secretariasQuery);
                
                secretariasTableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    secretariasTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Nenhuma secretaria/empresa cadastrada</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const secretaria = doc.data();
                    const row = document.createElement('tr');
                    
                    // Formatação da data
                    let dataFormatada = 'Data não disponível';
                    if (secretaria.dataCriacao) {
                        if (secretaria.dataCriacao instanceof Timestamp) {
                            const data = secretaria.dataCriacao.toDate();
                            dataFormatada = data.toLocaleDateString('pt-BR');
                        } else if (secretaria.dataCriacao.toDate) {
                            const data = secretaria.dataCriacao.toDate();
                            dataFormatada = data.toLocaleDateString('pt-BR');
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${secretaria.nome}</td>
                        <td>${dataFormatada}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-id="${doc.id}" data-nome="${secretaria.nome}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" data-id="${doc.id}" data-nome="${secretaria.nome}" data-type="secretaria" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    secretariasTableBody.appendChild(row);
                });
                
                // Adicionar event listeners para os botões de editar e excluir
                addEditSecretariaListeners();
                addDeleteItemListeners();
                
            } catch (error) {
                console.error("Erro ao carregar secretarias:", error);
                secretariasTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Erro ao carregar secretarias</td></tr>';
            }
        }
        
        // Carregar doações
        async function carregarDoacoes() {
            try {
                const doacoesQuery = query(collection(db, "doacoes"), orderBy("dataCadastro", "desc"));
                const querySnapshot = await getDocs(doacoesQuery);
                
                doacoesTableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    doacoesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma doação cadastrada</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const doacao = doc.data();
                    const row = document.createElement('tr');
                    
                    // Formatação da data
                    let dataFormatada = 'Data não disponível';
                    if (doacao.data) {
                        if (doacao.data instanceof Timestamp) {
                            const data = doacao.data.toDate();
                            dataFormatada = data.toLocaleDateString('pt-BR');
                        } else if (doacao.data.toDate) {
                            const data = doacao.data.toDate();
                            dataFormatada = data.toLocaleDateString('pt-BR');
                        }
                    }
                    
                    // Capitalizar a primeira letra da categoria
                    const categoria = doacao.categoria ? 
                        doacao.categoria.charAt(0).toUpperCase() + doacao.categoria.slice(1) : 
                        'Não definida';
                    
                    row.innerHTML = `
                        <td>${doacao.colaborador}</td>
                        <td>${doacao.premioNome}</td>
                        <td>${doacao.quantidade}</td>
                        <td>${doacao.secretariaNome}</td>
                        <td>${dataFormatada}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-id="${doc.id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" data-id="${doc.id}" data-nome="${doacao.premioNome} - ${doacao.colaborador}" data-type="doacao" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    doacoesTableBody.appendChild(row);
                });
                
                // Adicionar event listeners para os botões de editar e excluir
                addEditDoacaoListeners();
                addDeleteItemListeners();
                
            } catch (error) {
                console.error("Erro ao carregar doações:", error);
                doacoesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erro ao carregar doações</td></tr>';
            }
        }
        
        // Adicionar listeners para editar prêmios
        function addEditPremioListeners() {
            const editButtons = premiosTableBody.querySelectorAll('.edit-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const id = this.getAttribute('data-id');
                    const nome = this.getAttribute('data-nome');
                    
                    try {
                        // Buscar os dados do prêmio
                        const premioDoc = await getDoc(doc(db, "premios", id));
                        
                        if (premioDoc.exists()) {
                            const premio = premioDoc.data();
                            
                            editPremioId.value = id;
                            editPremioNome.value = nome;
                            document.getElementById('edit-premio-categoria').value = premio.categoria || 'brinde';
                            
                            editPremioModal.style.display = 'flex';
                        }
                    } catch (error) {
                        console.error("Erro ao carregar dados do prêmio:", error);
                        alert('Erro ao carregar dados do prêmio.');
                    }
                });
            });
        }
        
        // Adicionar listeners para editar secretarias
        function addEditSecretariaListeners() {
            const editButtons = secretariasTableBody.querySelectorAll('.edit-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const nome = this.getAttribute('data-nome');
                    
                    editSecretariaId.value = id;
                    editSecretariaNome.value = nome;
                    
                    editSecretariaModal.style.display = 'flex';
                });
            });
        }
        
        // Adicionar listeners para editar doações
        function addEditDoacaoListeners() {
            const editButtons = doacoesTableBody.querySelectorAll('.edit-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const id = this.getAttribute('data-id');
                    
                    try {
                        // Carregar dados para os selects
                        await carregarSelects();
                        
                        // Buscar os dados da doação
                        const doacaoDoc = await getDoc(doc(db, "doacoes", id));
                        
                        if (doacaoDoc.exists()) {
                            const doacao = doacaoDoc.data();
                            
                            // Preencher os campos do modal
                            editDoacaoColaborador.value = doacao.colaborador || '';
                            editDoacaoQuantidade.value = doacao.quantidade || 1;
                            editDoacaoNotaFiscal.value = doacao.notaFiscal || '';
                            editDoacaoId.value = id;
                            
                            // Selecionar o prêmio correto
                            Array.from(editDoacaoPremio.options).forEach(option => {
                                if (option.value === doacao.premioId) {
                                    option.selected = true;
                                }
                            });
                            
                            // Selecionar a secretaria correta
                            Array.from(editDoacaoSecretaria.options).forEach(option => {
                                if (option.value === doacao.secretariaId) {
                                    option.selected = true;
                                }
                            });
                            
                            // Formatar a data para o campo de data
                            if (doacao.data) {
                                const data = doacao.data instanceof Timestamp ? 
                                    doacao.data.toDate() : 
                                    doacao.data.toDate();
                                
                                const ano = data.getFullYear();
                                const mes = String(data.getMonth() + 1).padStart(2, '0');
                                const dia = String(data.getDate()).padStart(2, '0');
                                editDoacaoData.value = `${ano}-${mes}-${dia}`;
                            } else {
                                editDoacaoData.value = '';
                            }
                            
                            // Mostrar o modal
                            editDoacaoModal.style.display = 'flex';
                        } else {
                            alert('Doação não encontrada.');
                        }
                    } catch (error) {
                        console.error("Erro ao carregar dados da doação:", error);
                        alert('Erro ao carregar dados da doação.');
                    }
                });
            });
        }
        
        // Função para carregar selects (prêmios e secretarias)
        async function carregarSelects() {
            try {
                // Limpar opções atuais
                editDoacaoPremio.innerHTML = '';
                editDoacaoSecretaria.innerHTML = '';
                
                // Carregar prêmios
                const premiosQuery = query(collection(db, "premios"), orderBy("nome"));
                const premiosSnapshot = await getDocs(premiosQuery);
                
                premiosSnapshot.forEach((doc) => {
                    const premio = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = premio.nome;
                    editDoacaoPremio.appendChild(option);
                });
                
                // Carregar secretarias
                const secretariasQuery = query(collection(db, "secretarias"), orderBy("nome"));
                const secretariasSnapshot = await getDocs(secretariasQuery);
                
                secretariasSnapshot.forEach((doc) => {
                    const secretaria = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = secretaria.nome;
                    editDoacaoSecretaria.appendChild(option);
                });
                
            } catch (error) {
                console.error("Erro ao carregar selects:", error);
                throw error;
            }
        }
        
        // Função para atualizar prêmio
        async function atualizarPremio(id, novoNome, novaCategoria) {
            try {
                const premioRef = doc(db, "premios", id);
                await updateDoc(premioRef, {
                    nome: novoNome,
                    categoria: novaCategoria
                });
                
                alert(`Prêmio atualizado com sucesso!`);
                editPremioModal.style.display = 'none';
                carregarPremios();
            } catch (error) {
                console.error("Erro ao atualizar prêmio:", error);
                alert('Erro ao atualizar prêmio. Tente novamente.');
            }
        }
        
        // Função para atualizar secretaria
        async function atualizarSecretaria(id, novoNome) {
            try {
                const secretariaRef = doc(db, "secretarias", id);
                await updateDoc(secretariaRef, {
                    nome: novoNome
                });
                
                alert(`Secretaria/Empresa atualizada com sucesso!`);
                editSecretariaModal.style.display = 'none';
                carregarSecretarias();
            } catch (error) {
                console.error("Erro ao atualizar secretaria:", error);
                alert('Erro ao atualizar secretaria/empresa. Tente novamente.');
            }
        }
        
        // Função para atualizar doação
        async function atualizarDoacao(id, dadosAtualizados) {
            try {
                const doacaoRef = doc(db, "doacoes", id);
                
                // Buscar os dados atuais da doação para preservar os campos que não estão no formulário
                const doacaoDoc = await getDoc(doacaoRef);
                const dadosAtuais = doacaoDoc.exists() ? doacaoDoc.data() : {};
                
                // Buscar o nome do prêmio e da secretaria selecionados
                const premioDoc = await getDoc(doc(db, "premios", dadosAtualizados.premioId));
                const secretariaDoc = await getDoc(doc(db, "secretarias", dadosAtualizados.secretariaId));
                
                const dadosCompletos = {
                    ...dadosAtuais,                   // Mantém os dados existentes (incluindo categoria e observações)
                    ...dadosAtualizados,              // Sobrescreve com os dados atualizados do formulário
                    premioNome: premioDoc.exists() ? premioDoc.data().nome : "Não encontrado",
                    secretariaNome: secretariaDoc.exists() ? secretariaDoc.data().nome : "Não encontrada"
                };
                
                await updateDoc(doacaoRef, dadosCompletos);
                
                alert(`Doação atualizada com sucesso!`);
                editDoacaoModal.style.display = 'none';
                carregarDoacoes();
            } catch (error) {
                console.error("Erro ao atualizar doação:", error);
                alert('Erro ao atualizar doação. Tente novamente.');
            }
        }
        
        // Função para excluir item
        async function excluirItem(id, type) {
            try {
                if (type === 'premio') {
                    await deleteDoc(doc(db, "premios", id));
                    alert('Prêmio excluído com sucesso!');
                    carregarPremios();
                } else if (type === 'secretaria') {
                    await deleteDoc(doc(db, "secretarias", id));
                    alert('Secretaria/Empresa excluída com sucesso!');
                    carregarSecretarias();
                } else if (type === 'doacao') {
                    await deleteDoc(doc(db, "doacoes", id));
                    alert('Doação excluída com sucesso!');
                    carregarDoacoes();
                }
                
                deleteConfirmModal.style.display = 'none';
            } catch (error) {
                console.error("Erro ao excluir item:", error);
                alert('Erro ao excluir item. Tente novamente.');
            }
        }
        
        // Adicionar listeners para excluir itens
        function addDeleteItemListeners() {
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const nome = this.getAttribute('data-nome');
                    const type = this.getAttribute('data-type');
                    
                    deleteItemData = { id, nome, type };
                    
                    document.getElementById('delete-message').textContent = 
                        `Tem certeza que deseja excluir "${nome}"? Esta ação não pode ser desfeita.`;
                    
                    deleteConfirmModal.style.display = 'flex';
                });
            });
        }
        
        // Event listeners para as abas
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Atualizar classe ativa da aba
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar conteúdo da aba selecionada com efeito de fade
                tabContents.forEach(content => {
                    if (content.classList.contains('active')) {
                        content.style.opacity = '0';
                        setTimeout(() => {
                            content.classList.remove('active');
                        }, 300);
                    }
                });
                
                setTimeout(() => {
                    const selectedContent = document.getElementById(`${tabName}-tab`);
                    selectedContent.classList.add('active');
                    selectedContent.style.opacity = '1';
                }, 300);
            });
        });
        
        // Event listeners para modais
        document.getElementById('close-edit-premio-modal').addEventListener('click', () => {
            editPremioModal.style.display = 'none';
        });
        
        document.getElementById('cancel-edit-premio-btn').addEventListener('click', () => {
            editPremioModal.style.display = 'none';
        });
        
        document.getElementById('save-premio-btn').addEventListener('click', async () => {
            const id = editPremioId.value;
            const novoNome = editPremioNome.value.trim();
            const novaCategoria = document.getElementById('edit-premio-categoria').value;
            
            if (novoNome) {
                await atualizarPremio(id, novoNome, novaCategoria);
            } else {
                alert('Por favor, digite o nome do prêmio.');
            }
        });
        
        document.getElementById('close-edit-secretaria-modal').addEventListener('click', () => {
            editSecretariaModal.style.display = 'none';
        });
        
        document.getElementById('cancel-edit-secretaria-btn').addEventListener('click', () => {
            editSecretariaModal.style.display = 'none';
        });
        
        document.getElementById('save-secretaria-btn').addEventListener('click', async () => {
            const id = editSecretariaId.value;
            const novoNome = editSecretariaNome.value.trim();
            
            if (novoNome) {
                await atualizarSecretaria(id, novoNome);
            } else {
                alert('Por favor, digite o nome da secretaria/empresa.');
            }
        });
        
        document.getElementById('close-delete-modal').addEventListener('click', () => {
            deleteConfirmModal.style.display = 'none';
        });
        
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            deleteConfirmModal.style.display = 'none';
        });
        
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (deleteItemData) {
                await excluirItem(deleteItemData.id, deleteItemData.type);
            }
        });
        
        document.getElementById('close-edit-doacao-modal').addEventListener('click', () => {
            editDoacaoModal.style.display = 'none';
        });
        
        document.getElementById('cancel-edit-doacao-btn').addEventListener('click', () => {
            editDoacaoModal.style.display = 'none';
        });
        
        document.getElementById('save-doacao-btn').addEventListener('click', async () => {
            const id = editDoacaoId.value;
            const colaborador = editDoacaoColaborador.value.trim();
            const premioId = editDoacaoPremio.value;
            const quantidade = parseInt(editDoacaoQuantidade.value);
            const secretariaId = editDoacaoSecretaria.value;
            const dataStr = editDoacaoData.value;
            const notaFiscal = editDoacaoNotaFiscal.value.trim();
            
            if (!colaborador || !premioId || !secretariaId || !dataStr) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            const dadosAtualizados = {
                colaborador,
                premioId,
                quantidade: isNaN(quantidade) ? 1 : quantidade,
                secretariaId,
                data: new Date(dataStr),
                notaFiscal
            };
            
            await atualizarDoacao(id, dadosAtualizados);
        });
        
        // Fechar modais ao clicar fora
        window.addEventListener('click', (event) => {
            if (event.target === editPremioModal) {
                editPremioModal.style.display = 'none';
            }
            if (event.target === editSecretariaModal) {
                editSecretariaModal.style.display = 'none';
            }
            if (event.target === editDoacaoModal) {
                editDoacaoModal.style.display = 'none';
            }
            if (event.target === deleteConfirmModal) {
                deleteConfirmModal.style.display = 'none';
            }
        });
        
        // Função para verificar permissões do usuário
        async function checkUserPermissions() {
            const user = auth.currentUser;
            if (!user) {
                window.location.href = "../index.html";
                return null;
            }

            try {
                // Buscar o documento do usuário pelo UID
                const usersCollection = collection(db, "users");
                const q = query(usersCollection, where("uid", "==", user.uid));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.error("Usuário não encontrado no Firestore");
                    window.location.href = "../index.html";
                    return null;
                }
                
                // Pegar o primeiro documento (deve ser único)
                const userData = querySnapshot.docs[0].data();
                return userData.role;
            } catch (error) {
                console.error("Erro ao verificar permissões:", error);
                return null;
            }
        }
        
        // Função para atualizar visibilidade do menu conforme o papel do usuário
        function updateMenuVisibility(role) {
            const menuItems = document.querySelectorAll('.dropdown-item[data-page]');
            const logoutBtn = document.getElementById('logout-btn');
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            
            // Primeiro, esconder todos os itens
            menuItems.forEach(item => {
                item.style.display = 'none';
            });
            
            // Mostrar apenas os itens permitidos baseado no papel
            if (role === 'admin') {
                // Admin tem acesso a tudo
                menuItems.forEach(item => {
                    item.style.display = 'flex';
                });
            } else if (role === 'editor') {
                // Editor tem acesso a tudo exceto gerenciar usuários
                menuItems.forEach(item => {
                    const page = item.getAttribute('data-page');
                    if (page !== 'gerenciar-usuarios.html') {
                        item.style.display = 'flex';
                    }
                });
            } else if (role === 'reader') {
                // Leitor só tem acesso ao dashboard
                menuItems.forEach(item => {
                    const page = item.getAttribute('data-page');
                    if (page === 'dashboard.html') {
                        item.style.display = 'flex';
                    }
                });
            }
            
            // Garantir que o botão de logout esteja sempre visível
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
            }
            
            // Garantir que o dropdown toggle esteja sempre visível
            if (dropdownToggle) {
                dropdownToggle.style.display = 'flex';
            }
            
            // Garantir que o dropdown menu tenha display padrão (não afete a exibição/ocultação via classe)
            if (dropdownMenu) {
                dropdownMenu.style.display = '';
            }
        }

        // Verificar se o usuário está autenticado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Verificar permissões
                    const userRole = await checkUserPermissions();
                    
                    // Verificar se o usuário tem permissão para acessar esta página
                    if (userRole !== 'admin' && userRole !== 'editor') {
                        alert('Você não tem permissão para acessar esta página.');
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    // Atualizar o menu conforme o papel do usuário
                    updateMenuVisibility(userRole);
                    
                    // Buscar dados do usuário no Firestore (em segundo plano)
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    
                    if (userDoc.exists()) {
                        // Se encontrou o documento do usuário
                        const userData = userDoc.data();
                        const userName = userData.nome;
                        
                        if (userName) {
                            document.getElementById('user-name').textContent = userName;
                            
                            const avatarElement = document.querySelector('.avatar');
                            if (userName.length > 0) {
                                const userInitial = userName.charAt(0).toUpperCase();
                                avatarElement.textContent = userInitial;
                                
                                sessionStorage.setItem('userName', userName);
                                sessionStorage.setItem('userInitial', userInitial);
                            }
                        }
                    } else {
                        // Usar email apenas se não houver nome no sessionStorage
                        if (!sessionStorage.getItem('userName')) {
                            const userEmail = user.email;
                            document.getElementById('user-name').textContent = userEmail;
                            sessionStorage.setItem('userName', userEmail);
                        }
                    }
                    
                    // Carregar dados
                    await carregarDoacoes();
                    await carregarPremios();
                    await carregarSecretarias();
                    
                    // Configurar eventos de pesquisa
                    configurarPesquisaDoacao();
                    
                } catch (error) {
                    console.error("Erro ao buscar dados do usuário:", error);
                    // Não alterar a interface se já tiver dados no sessionStorage
                }
            } else {
                // Limpar o sessionStorage ao fazer logout
                sessionStorage.removeItem('userName');
                sessionStorage.removeItem('userInitial');
                
                // Usuário não está logado, redirecionar para a página de login
                window.location.href = "../index.html";
            }
        });
        
        // Função para configurar a pesquisa de doações
        function configurarPesquisaDoacao() {
            const pesquisaInput = document.getElementById('pesquisa-doacao');
            const btnPesquisar = document.getElementById('btn-pesquisar-doacao');
            const btnLimpar = document.getElementById('btn-limpar-pesquisa');
            
            // Pesquisar ao clicar no botão
            btnPesquisar.addEventListener('click', () => {
                pesquisarDoacoes(pesquisaInput.value.trim());
            });
            
            // Pesquisar ao pressionar Enter
            pesquisaInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    pesquisarDoacoes(pesquisaInput.value.trim());
                }
            });
            
            // Limpar pesquisa
            btnLimpar.addEventListener('click', () => {
                pesquisaInput.value = '';
                carregarDoacoes(); // Recarregar todas as doações
            });
        }
        
        // Função para pesquisar doações
        async function pesquisarDoacoes(termo) {
            if (!termo) {
                carregarDoacoes();
                return;
            }
            
            try {
                const termoLowerCase = termo.toLowerCase();
                const doacoesQuery = query(collection(db, "doacoes"), orderBy("dataCadastro", "desc"));
                const querySnapshot = await getDocs(doacoesQuery);
                
                doacoesTableBody.innerHTML = '';
                
                let encontrouResultados = false;
                
                querySnapshot.forEach((doc) => {
                    const doacao = doc.data();
                    
                    // Verificar se o termo de pesquisa está no colaborador ou no nome do prêmio
                    if (
                        doacao.colaborador.toLowerCase().includes(termoLowerCase) || 
                        doacao.premioNome.toLowerCase().includes(termoLowerCase) ||
                        doacao.secretariaNome.toLowerCase().includes(termoLowerCase)
                    ) {
                        encontrouResultados = true;
                        
                        const row = document.createElement('tr');
                        
                        // Formatação da data
                        let dataFormatada = 'Data não disponível';
                        if (doacao.data) {
                            if (doacao.data instanceof Timestamp) {
                                const data = doacao.data.toDate();
                                dataFormatada = data.toLocaleDateString('pt-BR');
                            } else if (doacao.data.toDate) {
                                const data = doacao.data.toDate();
                                dataFormatada = data.toLocaleDateString('pt-BR');
                            }
                        }
                        
                        // Capitalizar a primeira letra da categoria
                        const categoria = doacao.categoria ? 
                            doacao.categoria.charAt(0).toUpperCase() + doacao.categoria.slice(1) : 
                            'Não definida';
                        
                        row.innerHTML = `
                            <td>${doacao.colaborador}</td>
                            <td>${doacao.premioNome}</td>
                            <td>${doacao.quantidade}</td>
                            <td>${doacao.secretariaNome}</td>
                            <td>${dataFormatada}</td>
                            <td class="action-buttons">
                                <button class="edit-btn" data-id="${doc.id}" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" data-id="${doc.id}" data-nome="${doacao.premioNome} - ${doacao.colaborador}" data-type="doacao" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        doacoesTableBody.appendChild(row);
                    }
                });
                
                if (!encontrouResultados) {
                    doacoesTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Nenhuma doação encontrada com o termo "${termo}"</td></tr>`;
                } else {
                    // Adicionar event listeners aos botões de editar e excluir
                    addEditDoacaoListeners();
                    addDeleteItemListeners();
                }
                
            } catch (error) {
                console.error("Erro ao pesquisar doações:", error);
                doacoesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erro ao pesquisar doações</td></tr>';
            }
        }
        
        // Função de logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            // Limpar o sessionStorage ao fazer logout
            sessionStorage.removeItem('userName');
            sessionStorage.removeItem('userInitial');
            
            signOut(auth).then(() => {
                window.location.href = "../index.html";
            }).catch((error) => {
                alert("Erro ao fazer logout: " + error.message);
            });
        });
        
        // Dropdown functionality com navegação otimizada
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            
            // Toggle dropdown when clicked
            dropdownToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                if (dropdownMenu.classList.contains('show')) {
                    dropdownMenu.classList.remove('show');
                }
            });
            
            // Prevent dropdown from closing when clicking inside it
            dropdownMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Adicionar evento de clique para os itens de menu com data-page
            document.querySelectorAll('.dropdown-item[data-page]').forEach(item => {
                item.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const pageName = this.getAttribute('data-page');
                    
                    if (window.location.pathname.endsWith(pageName)) {
                        document.querySelector('.dropdown-menu').classList.remove('show');
                        return;
                    }

                    // Verificar permissões antes de navegar
                    const userRole = await checkUserPermissions();
                    
                    if (!userRole) {
                        window.location.href = "../index.html";
                        return;
                    }

                    // Verificar permissões para a página específica
                    if (userRole === 'reader' && pageName !== 'dashboard.html') {
                        alert('Você não tem permissão para acessar esta página.');
                        return;
                    }

                    if (userRole === 'editor' && pageName === 'gerenciar-usuarios.html') {
                        alert('Você não tem permissão para acessar esta página.');
                        return;
                    }

                    // Mostrar overlay de carregamento e navegar
                    showLoadingOverlay();
                    window.location.href = pageName;
                });
            });
            
            // Aplicar dados do usuário da sessão se disponíveis
            applyUserSessionData();
        });
        
        // Função para mostrar overlay de carregamento com efeito de fade
        function showLoadingOverlay() {
            // Criar o overlay com fundo transparente inicialmente
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(255, 255, 255, 0)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.transition = 'background-color 0.5s ease';
            
            // Adicionar efeito de fade para todo o corpo da página
            document.body.style.opacity = '1';
            document.body.style.transition = 'opacity 0.3s ease-out';
            
            // Criar o spinner
            const spinner = document.createElement('div');
            spinner.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #6c63ff; opacity: 0; transition: opacity 0.3s ease-in;"></i>';
            overlay.appendChild(spinner);
            
            // Adicionar ao corpo
            document.body.appendChild(overlay);
            
            // Salvar informações do usuário para recuperar rapidamente na próxima página
            const userName = document.getElementById('user-name').textContent;
            const userInitial = document.querySelector('.avatar').textContent;
            
            sessionStorage.setItem('userName', userName);
            sessionStorage.setItem('userInitial', userInitial);
            
            // Aplicar animação com delay para criar efeito suave
            setTimeout(() => {
                overlay.style.backgroundColor = 'rgba(255, 255, 255, 0.97)';
                document.body.style.opacity = '0.8';
                spinner.querySelector('i').style.opacity = '1';
            }, 50);
        }
        
        // Aplicar dados do usuário da sessão
        function applyUserSessionData() {
            const userName = sessionStorage.getItem('userName');
            const userInitial = sessionStorage.getItem('userInitial');
            
            if (userName) {
                document.getElementById('user-name').textContent = userName;
            }
            
            if (userInitial) {
                document.querySelector('.avatar').textContent = userInitial;
            }
        }
        
        // Executar assim que o DOM estiver pronto para exibir os dados do usuário de imediato
        applyUserSessionData();
        
        // Adicionar efeito de fade-in ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            // Definir opacidade inicial para 0 e depois animar para 1
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.5s ease-in';
            
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });
    </script>
</body>
</html> 